name: CI - Inventory Management

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build_and_quality:
    name: Build, Lint & Test (Quality Gate)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"            # Cache npm deps for faster CI :contentReference[oaicite:0]{index=0}

      - name: Install dependencies
        run: npm ci

      # ---------- QUALITY GATE: CODE QUALITY ----------
      - name: Run ESLint
        run: npm run lint
        # If lint fails (exit code != 0), this job fails
        # and the pipeline stops here (quality gate)

      - name: Run unit tests
        run: npm test
        # If tests fail, job fails -> quality gate

      # OPTIONAL: if you have coverage setup (e.g. Jest/nyc)
      # - name: Run tests with coverage
      #   run: npm test -- --coverage

  package_artifact:
    name: Package Versioned Artifact
    needs: build_and_quality         # Only run if quality gate passed
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install production dependencies
        run: npm ci --omit=dev

      - name: Compute artifact version
        id: version
        run: |
          short_sha=${GITHUB_SHA::7}
          version="inv-${GITHUB_RUN_NUMBER}-${short_sha}"
          echo "artifact_version=$version" >> "$GITHUB_OUTPUT"
          echo "Artifact version: $version"

      - name: Prepare artifact directory
        run: |
          mkdir -p artifact
          cp package.json package-lock.json server.js ecosystem.config.js artifact/ || true
          cp -r models routes views public artifact/ || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.version.outputs.artifact_version }}
          path: artifact
